---
title: "**Adult Dataset Prediction**"
author: "_Alexandru Damian_"
date: "12/1/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(plyr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(gmodels)
library(grid)
library(vcd)
library(scales)
library(ggthemes)
library(knitr)
library(caret)
library(GoodmanKruskal)
```

## Overview

The Adult data set was extracted in 1994 from census data of the United States. It contains continuous and nominal attributes, describing some social information (age, race, sex, marital status, ...) about the citizens registered. This dataset is split into 2 parts: adult.data for training and adult.test for testing the model performance.

The task is to predict whether the citizen’s income exceeds fifty thousand dollars a year.  
For this report, the focus will be on inference, drawing logical conclusions from the dataset. 

```{r load data, echo=FALSE}
db.adult <- read.table("adult.data", sep = ",", header = FALSE)
# dim(db.adult)[1]
# dim(db.adult)[2]
```

The number of observations is 32561 and the number of variables is 15.

```{r}
colnames(db.adult) <- c("age", "workclass", "fnlwgt", 
                        "education", "education_num", 
                        "marital_status", "occupation",
                        "relationship", "race", "sex", 
                        "capital_gain", "capital_loss", 
                        "hours_per_week", "native_country", "income")
```
```{r, echo=FALSE}
head(db.adult, 3)
# str(db.adult, vec.len = 2, strict.width = "no", width = 30)
```

```{r, echo=F, results='hide'}
levels_factors <- function(mydata) {
    col_names <- names(mydata)
    for (i in 1:length(col_names)) {
        if (is.factor(mydata[, col_names[i]])) {
             # message(noquote(paste("Covariate ", "*", 
             #                     col_names[i], "*", 
             #                     " with factor levels:", 
             #                     sep = "")))
             # print(levels(mydata[, col_names[i]]))
        }
    }
}
db.adult <- mutate_if(db.adult, is.character, as.factor)
levels_factors(db.adult)
```

```{r remove, echo=FALSE, results='hide'}
db.adult <- read.table("adult.data",
                       sep = ",", 
                       header = FALSE, 
                       na.strings = " ?")
colnames(db.adult) <- c("age", "workclass", "fnlwgt", "education", 
                        "education_num", "marital_status", "occupation",
                        "relationship", "race", "sex", "capital_gain", 
                        "capital_loss", "hours_per_week", "native_country", "income")
db.adult <- na.omit(db.adult)
row.names(db.adult) <- 1:nrow(db.adult)
db.adult <- mutate_if(db.adult, is.character, as.factor)
```

## **Data Transformations**

### **1. hours_per_week**

The mean number of working hours per week is 41 and around 50% of the people that responded the survey work between 40 and 35 hours per week. 

```{r, echo=FALSE}
summary(db.adult$hours_per_week)
```
```{r, echo=FALSE}
ggplot(aes(x = factor(0), y = hours_per_week),
       data = db.adult) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19,
               color = "red",
               cex = 2) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = seq(0, 100, 5)) + 
  xlab(label = "") +
  ylab(label = "Working hours per week") +
  ggtitle("Box Plot of Working Hours per Week") 
```
The width of the boxplot is equal to the Interquartile range. It is also noticeable that there are many outliers in the data represented by the black dots.  
In order to work with the data to make predictions, the working hours will be grouped in 5 categories:  
1. less than 40 hours per week  
2. between 40 and 45 hours per week  
3. between 45 and 60 hours per week  
4. between 60 and 80 hours per week  
5. more than 80 hours per week  

```{r, echo=FALSE}
db.adult$hours_w[db.adult$hours_per_week < 40] <- " less_than_40"
db.adult$hours_w[db.adult$hours_per_week >= 40 & 
                 db.adult$hours_per_week <= 45] <- " between_40_and_45"
db.adult$hours_w[db.adult$hours_per_week > 45 &
                 db.adult$hours_per_week <= 60  ] <- " between_45_and_60"
db.adult$hours_w[db.adult$hours_per_week > 60 &
                 db.adult$hours_per_week <= 80  ] <- " between_60_and_80"
db.adult$hours_w[db.adult$hours_per_week > 80] <- " more_than_80"
```

```{r}
db.adult$hours_w <- factor(db.adult$hours_w,
                           ordered = FALSE,
                           levels = c(" less_than_40", 
                                      " between_40_and_45", 
                                      " between_45_and_60",
                                      " between_60_and_80",
                                      " more_than_80"))
```

```{r, echo=FALSE, results='hide'}
summary(db.adult$hours_w)
```

Percentages  

24% of people work less than 40 hours/week   
54% work between 40 and 45 hours/week  
3% work between 60 and 80 hours/week   
0.6% work more than 80 hours/week  
```{r, echo=F, results='hide'}
for(i in 1:length(summary(db.adult$hours_w))){
   print(round(100*summary(db.adult$hours_w)[i]/sum(!is.na(db.adult$hours_w)), 2))
}
```
### **2. native_country**

There are 61 countries listed in the survey. This complicated the anlysis and might lead to overfitting.  
The solution is to group native_country into native_region.

```{r}
Asia_East <- c(" Cambodia", " China", " Hong", " Laos", " Thailand",
               " Japan", " Taiwan", " Vietnam")

Asia_Central <- c(" India", " Iran")

Central_America <- c(" Cuba", " Guatemala", " Jamaica", " Nicaragua", 
                     " Puerto-Rico",  " Dominican-Republic", " El-Salvador", 
                     " Haiti", " Honduras", " Mexico", " Trinadad&Tobago")

South_America <- c(" Ecuador", " Peru", " Columbia")


Europe_West <- c(" England", " Germany", " Holand-Netherlands", " Ireland", 
                 " France", " Greece", " Italy", " Portugal", " Scotland")

Europe_East <- c(" Poland", " Yugoslavia", " Hungary")
```

```{r, echo=FALSE}
# Add native_region to dataframe
db.adult <- mutate(db.adult, 
       native_region = ifelse(native_country %in% Asia_East, " East-Asia",
                ifelse(native_country %in% Asia_Central, " Central-Asia",
                ifelse(native_country %in% Central_America, " Central-America",
                ifelse(native_country %in% South_America, " South-America",
                ifelse(native_country %in% Europe_West, " Europe-West",
                ifelse(native_country %in% Europe_East, " Europe-East",
                ifelse(native_country == " United-States", " United-States", 
                       " Outlying-US" ))))))))
```

```{r, echo=F}
#Convert variable to factor
db.adult$native_region <- factor(db.adult$native_region, ordered = FALSE)
```

### **3. capital_gain and capital_loss**

91% of capital_gain consists of 0   
95% of capital_loss consists of 0  

This can disrupt the analysis and as a result they need to be removed. In case they are removed, these values will be replaced with the mean.  
The next table provides an overview of the resulting data, divided into quantiles. .

```{r, echo=F, results='hide'}
summary(db.adult$capital_gain)
summary(db.adult$capital_loss)
(nrow(subset(db.adult, db.adult$capital_gain == 0))/nrow(db.adult))*100
(nrow(subset(db.adult, db.adult$capital_loss == 0))/nrow(db.adult))*100

mean.gain <- mean(db.adult$capital_gain)

mean.loss <- mean(db.adult$capital_loss)

kable(data.frame(Mean_Capital_Gain = mean.gain, Mean_Capital_Loss = mean.loss),
      caption = "Mean Capital with Zero Values Included")
```

```{r, echo=F, results='hide'}
mean.gain <- mean(subset(db.adult$capital_gain, db.adult$capital_gain > 0))

mean.loss <- mean(subset(db.adult$capital_loss, db.adult$capital_loss > 0))

kable(data.frame(Mean_Capital_Gain = mean.gain, Mean_Capital_Loss = mean.loss),
      caption = "Mean Capital Only for Nonzero Values")
```

```{r, echo=F}
iqr.gain <- IQR(subset(db.adult$capital_gain, db.adult$capital_gain > 0))
iqr.loss <- IQR(subset(db.adult$capital_loss, db.adult$capital_loss > 0))



q.gain <- quantile(x = subset(db.adult$capital_gain, db.adult$capital_gain > 0), 
                   probs = seq(0, 1, 0.25))

q.loss <- quantile(x = subset(db.adult$capital_loss, db.adult$capital_loss > 0),
                   probs = seq(0, 1, 0.25))


kable(x = data.frame(Capital_Gain = q.gain, Capital_Loss = q.loss),
      caption = "Quantiles of the Nonzero Capital")
kable(x = data.frame(IQR_Capital_Gain = iqr.gain, IQR_Capital_Loss = iqr.loss),
      caption = "IQR of the Nonzero Capital")
```

```{r, echo=F, out.width="90%"}
ggplot(aes(x = factor(0), y = capital_gain),
        data = subset(db.adult, db.adult$capital_gain > 0)) + 
    geom_boxplot() +
    stat_summary(fun = mean, 
                 geom = 'point', 
                 shape = 19,
                 color = "red",
                 cex = 2) +
    scale_x_discrete(breaks = NULL) +
    scale_y_continuous(breaks = seq(0, 100000, 5000)) +
    ylab("Capital Gain") +
    xlab("") +  
    ggtitle("Box plot of Nonzero Capital Gain") 
```

From the box plot it is noticeable that most capital gain is between $3,000 and $15,000.

```{r, echo=F, out.width="90%"}
df <- db.adult[db.adult$capital_gain > 0, ]

ggplot(data = df, 
       aes(x = df$capital_gain)) +
  geom_histogram(binwidth = 5000,
                 bins = 30,
                 colour = "black",
                 fill = "lightblue",
                 alpha = 0.4) +
  scale_y_continuous(breaks = seq(0, 4000, 100)) +
  labs(x = "Capital gain", y = "Count") +
  ggtitle("Histogram of Nonzero Capital Gain")
```

From the histogram it is noticeable that most people with capital gain are situated between 0 and $25,000 and the majority gains around $5,000.

```{r, echo=F, out.width="92%"}
ggplot(aes(x = factor(0), y = capital_loss),
       data = subset(db.adult, db.adult$capital_loss > 0)) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19,
               color = "red",
               cex = 2) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = seq(0, 5000, 500)) +
  ylab("Capital Loss") +
  xlab("") +  
  ggtitle("Box plot of Nonzero Capital Loss") 
```

Most values lie between $1,700 and $2,000 and there are also many outliers. 

```{r, echo=F, out.width="92%"}
df <- db.adult[db.adult$capital_loss > 0, ]

ggplot(data = df, 
       aes(x = df$capital_loss)) +
  geom_histogram(colour = "black",
                 bins = 30,
                 fill = "lightblue",
                 alpha = 0.4) +
  scale_x_continuous(breaks = seq(0, 5000, 250)) +
  scale_y_continuous(breaks = seq(0, 450, 50)) +
  labs(x = "Capital loss", y = "Count") +
  ggtitle("Histogram of Nonzero Capital Loss") 
```

The biggest number of people have a capital loss of approximately $1,800. 


Now when it comes to data transformation, using _Table 1: Quantiles of the Nonzero Capital_ capital_loss and capital_gain will be divided based on quintiles.

<!-- cap_gain -->
```{r}
db.adult <- mutate(db.adult, 
            cap_gain = ifelse(db.adult$capital_gain < 3464, " Low",
                       ifelse(db.adult$capital_gain >= 3464 & 
                              db.adult$capital_gain <= 14080, " Medium", " High")))

```

```{r, echo=F}
db.adult$cap_gain <- factor(db.adult$cap_gain,
                            ordered = TRUE,
                            levels = c(" Low", " Medium", " High"))
```

<!-- cap_loss -->
```{r}
db.adult <- mutate(db.adult, 
            cap_loss = ifelse(db.adult$capital_loss < 1672, " Low",
                       ifelse(db.adult$capital_loss >= 1672 & 
                              db.adult$capital_loss <= 1977, " Medium", " High")))
```

```{r, echo=F}
db.adult$cap_loss <- factor(db.adult$cap_loss,
                            ordered = TRUE,
                            levels = c(" Low", " Medium", " High"))
```

## Pre-processing the Test Dataset

It is required to apply the same steps as those for training dataset.

```{r, echo=F, results='hide'}
db.test <- read.table("adult.test",
                      sep = ",", 
                      header = FALSE, 
                      skip = 1, 
                      na.strings = " ?")
```

The number of observations is 16281.

```{r, echo=F, results='hide'}
dim(db.test)[1]
```
```{r}
colnames(db.test) <- c("age", "workclass", "fnlwgt", "education",
                       "education_num", "marital_status", "occupation",
                       "relationship", "race", "sex", "capital_gain",
                       "capital_loss", "hours_per_week",
                       "native_country", "income")

db.test <- na.omit(db.test)
row.names(db.test) <- 1:nrow(db.test)
head(db.test, 5)
```
```{r, echo=F, results='hide'}
# Character to factor
db.test <- mutate_if(db.test, is.character, as.factor)
```

It is noticeable that the naming convention for income is not consistent across the 2 datasets.The column will values will have to be renamed. After renaming them, the steps from the adult dataset need to be applied to the test dataset.

```{r, echo=F, results='hide'}
levels(db.test$income)[1] <- " <=50K"
levels(db.test$income)[2] <- " >50K"
levels(db.test$income)
```

```{r, echo=F, results='hide'}
# Working hours
db.test$hours_w[db.test$hours_per_week < 40] <- " less_than_40"
db.test$hours_w[db.test$hours_per_week >= 40 & 
                db.test$hours_per_week <= 45] <- " between_40_and_45"
db.test$hours_w[db.test$hours_per_week > 45 &
                db.test$hours_per_week <= 60  ] <- " between_45_and_60"
db.test$hours_w[db.test$hours_per_week > 60 &
                db.test$hours_per_week <= 80  ] <- " between_60_and_80"
db.test$hours_w[db.test$hours_per_week > 80] <- " more_than_80"

db.test$hours_w <- factor(db.test$hours_w,
                          ordered = FALSE,
                          levels = c(" less_than_40", 
                                     " between_40_and_45", 
                                     " between_45_and_60",
                                     " between_60_and_80",
                                     " more_than_80"))
```

```{r, echo=F, results='hide'}
# Native region
db.test <- mutate(db.test, 
       native_region = ifelse(native_country %in% Asia_East, " East-Asia",
                ifelse(native_country %in% Asia_Central, " Central-Asia",
                ifelse(native_country %in% Central_America, " Central-America",
                ifelse(native_country %in% South_America, " South-America",
                ifelse(native_country %in% Europe_West, " Europe-West",
                ifelse(native_country %in% Europe_East, " Europe-East",
                ifelse(native_country == " United-States", " United-States", 
                       " Outlying-US" ))))))))


db.test$native_region <- factor(db.test$native_region, ordered = FALSE)
```

```{r, echo=F, results='hide'}
# Cap gain, cap loss

db.test <- mutate(db.test, 
            cap_gain = ifelse(db.test$capital_gain < 3464, " Low",
                       ifelse(db.test$capital_gain >= 3464 & 
                              db.test$capital_gain <= 14080, " Medium", " High")))

db.test$cap_gain <- factor(db.test$cap_gain,
                            ordered = FALSE,
                            levels = c(" Low", " Medium", " High"))

db.test<- mutate(db.test, 
            cap_loss = ifelse(db.test$capital_loss < 1672, " Low",
                       ifelse(db.test$capital_loss >= 1672 & 
                              db.test$capital_loss <= 1977, " Medium", " High")))


db.test$cap_loss <- factor(db.test$cap_loss,
                            ordered = FALSE,
                            levels = c(" Low", " Medium", " High"))
```

## Exporting the processed datasets

The changed datasets are ready to be analyzed and exported. 
```{r}
write.csv(db.adult, "adult_df.csv", row.names = FALSE)

write.csv(db.test, "test_df.csv", row.names = FALSE)
```

## EDA - Exploratory Data Analysis

Now having pre-processed both datasets, it is possible to start analyzing the data.

### Summary statistic

```{r, echo=F}
db.adult <- read.csv("adult_df.csv")
db.adult <- mutate_if(db.adult, is.character,  as.factor)
summary(db.adult$income)
# class(db.adult$income)
# levels(db.adult$income)
```
```{r, echo=F}
ggplot(data = db.adult, 
       mapping = aes(x = income, fill = income)) + 
  geom_bar(mapping = aes(y = (..count..)/sum(..count..))) +
  geom_text(mapping = aes(label = scales::percent((..count..)/sum(..count..)),
                      y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1) +
  labs(x = "Income", 
       y = "",
       fill = "Income") +
  scale_y_continuous(labels = percent)
```

The graph above shows that 3/4 of people earn less than 50K a year and 1/4 of people earn above 50k a year. 

### Capital gain and capital loss

```{r, echo=F, out.width="85%"}
ggplot(mapping = aes(x = income, y = capital_gain),
       data = subset(db.adult, db.adult$capital_gain > 0)) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19,
               color = "red",
               cex = 2) +
  coord_cartesian(ylim = c(0, 30000)) +
  scale_y_continuous(breaks = seq(0, 30000, 1500)) +
  labs(x = "Income", 
       y = "Capital Gain") +
  ggtitle("Box Plot of Nonzero Capital Gain by Income") 
```

```{r, echo=F, out.width="85%"}
ggplot(mapping = aes(x = income, y = capital_loss),
       data = subset(db.adult, db.adult$capital_loss > 0)) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19,
               color = "red",
               cex = 2) +
  coord_cartesian(ylim = c(0, 3000))+
  scale_y_continuous(breaks = seq(0, 3000, 200)) +
  labs(x = "Income", 
       y = "Capital Loss") +
  ggtitle("Box Plot of Nonzero Capital Loss by Income")  
```

There is evidence of a strong relationship between the nonzero values of _capital_gain_, _capital_loss_ and _income_. Despite the correlation, these variables will not be included in the predictive model due do the high number of 0 values that have been removed during pre-processing. The observation that 90% of the values were 0's means that less than 10% of the survey participants make any investments. 

```{r, echo=F, out.width="85%"}
lg_cap.gain <- lapply(X = levels(db.adult$income), FUN = function(v){
  
  df <- subset(db.adult, db.adult$income == v)    
  
  df <- within(df, cap_gain <- factor(cap_gain, 
                                      levels = names(sort(table(cap_gain), 
                                                          decreasing = TRUE))))
    
  ggplot(data = df, 
         aes(x = cap_gain, 
             fill = cap_gain)) + 
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
              stat = "count",
              vjust = -.1) +
    labs(x = "Capital Gain", 
         y = "",
         fill = "Capital Gain") +
    theme(legend.position = 'none') +
    ggtitle(paste("Income", v, sep = "")) +  
    scale_y_continuous(labels = percent) })


grid.arrange(grobs = lg_cap.gain, ncol = 2)
```

From the bar plot it is noticeable that the proportion of people with medium and high capital gain is significantly bigger within the group of people that earn more than 50K a year. 

```{r, echo=F, out.width="85%"}
lg_cap.loss <- lapply(levels(db.adult$income), function(v){
    
  df <- subset(db.adult, db.adult$income == v)    
  
  df <- within(df, cap_loss <- factor(cap_loss, 
                                      levels = names(sort(table(cap_loss), 
                                                          decreasing = TRUE))))    
  
  ggplot(data = df, 
         aes(x = cap_loss, 
             fill = cap_loss)) + 
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
              stat = "count",
              vjust = -.1) +
    labs(x = "Capital Loss", 
         y = "",
         fill = "Capital Loss") +
    theme(legend.position = 'none') +
    ggtitle(paste("Income", v, sep="")) +  
    scale_y_continuous(labels = percent) })


grid.arrange(grobs = lg_cap.loss, ncol = 2)
```

Combining the results from the above graphs, it is possible to conclude that the differences in capital gains and capital losses between the 2 groups could be explained reasoning that wealthier people tend to invest more often and into more volatile assets. 

### Age

At least 50% of the people in the survey are between 28 and 47 years old. The dataset also has outliers, as there are people between 75 and 90 years old still working.  
Most individuals are between 20 and 50 years old. 

```{r}
summary(db.adult$age)
IQR(db.adult$age)
```
```{r, echo=F}
ggplot(mapping = aes(x = factor(0), y = age),
       data = db.adult) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19,
               color = "red",
               cex = 2) +
  coord_cartesian(ylim = c(10, 100)) +
  scale_y_continuous(breaks = seq(10, 100, 5)) +
  ylab("Age") +
  xlab("") +  
  ggtitle("Box Plot of Age") +
  scale_x_discrete(breaks = NULL)
```

```{r, echo=F, out.width="85%"}
qplot(x = age, 
      data = db.adult, 
      binwidth = 5, 
      color = I('black'), 
      fill = I('#F29025'),
      xlab = "Age",
      ylab = "Count",
      main = "Histogram of Age") +
  scale_x_continuous(breaks = seq(0, 95, 5)) +   
  scale_y_continuous(breaks = seq(0, 4500, 500))
```

From the density graph it is noticeable that the majority of people earning more than 50K a year are between 30 and 55 years old and for the other group it is between the ages of 18 and 45.  
There appears to be a strong correlation between age and income. 

```{r, echo=F, out.width="95%"}
ggplot(data = db.adult, aes(age, fill = income)) + 
  geom_density(alpha = 0.2) +
  scale_x_continuous(breaks = seq(0, 95, 5))
```

People who earn more than 50K a year are on average 43-44 years old and people who earn less than 50K are, on average, 34 to 37 years old.

```{r, echo=F, out.width="90%"}
ggplot(data = db.adult, mapping = aes(x = age)) + 
  geom_histogram(binwidth = 5,
                 color = "black",
                 fill = "lightblue",
                 alpha = 0.6) +
  scale_x_continuous(breaks = seq(0, 95, 5)) + 
  facet_wrap(~income) +
  ggtitle("Histogram of Age by Income") 
```


```{r, echo=F, out.width="90%"}
ggplot(aes(x = income, y = age),
       data = db.adult) + 
  geom_boxplot() +
  stat_summary(fun  = mean, 
               geom = "point", 
               shape = 16, 
               cex = 2, 
               col = "red") +
  coord_cartesian(ylim = c(10, 90))+
  scale_y_continuous(breaks = seq(10, 90, 5)) +
  ylab("Age") +
  xlab("Income") +  
  ggtitle("Box Plot of Age by Income") 
```


```{r, echo=F, results='hide'}
summary(subset(db.adult$age, db.adult$income == " <=50K"))
summary(subset(db.adult$age, db.adult$income == " >50K"))
```
Men tend to work more hours per week across all age groups. This relation changes after the age of 70 years, but that data should be neglected as it is extremely uncommon for people to work at that age. 

```{r, echo=F, out.width="90%"}
ggplot(aes(x = age, y = hours_per_week),
       data = db.adult) + 
  geom_line(mapping = aes(color = sex), 
            stat = 'summary', 
            fun = mean) +
  geom_smooth(mapping = aes(color = sex), method = 'gam', formula = y ~ s(x, bs = "cs")) + 
  scale_x_continuous(breaks = seq(10, 100, 5)) +
  scale_y_continuous(breaks = seq(0, 55, 5)) +  
  labs(x = "Age", y = "Mean Hours per Week") +
  ggtitle("Age vs. Mean Hours per Week by Gender")
```

### Hours per week

The mean number of hours per week is 41 and at least 50% of the survey participants work between 40 and 45 hours a week. 

```{r}
summary(db.adult$hours_per_week)
IQR(db.adult$hours_per_week)
```
```{r, echo=F, out.width="90%"}
ggplot(aes(x = factor(0), y = hours_per_week),
       data = db.adult) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = "point", 
               color = "red",
               shape = 19,
               cex = 2) +
  coord_cartesian(ylim = c(30, 50)) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = seq(30, 50, 1)) +
  ylab("Hours per Week") +
  xlab("") +  
  ggtitle("Box plot of Hours per Week") 
```

```{r, echo=F, out.width="90%"}
ggplot(aes(x = income, y = hours_per_week),
       data = db.adult) + 
  geom_boxplot() +
  stat_summary(fun = mean, 
               geom = 'point', 
               shape = 19, 
               color = "red", 
               cex = 2) +
  coord_cartesian(ylim = c(30, 60))+
  scale_y_continuous(breaks = seq(30, 60, 1)) +
  ylab("Hours per Week") +
  xlab("Income") +  
  ggtitle("Box Plot of Hours per Week by Income") 
```

As it is observable from the box plot, the number of working hours for people that earn more than 50K is significantly higher than for people who earn less than 50K.  
For all age groups, the number of working hours for the people that earn more than 50K a year is higher than for those that earn less than 50K.

```{r, echo=F, out.width="92%"}
ggplot(mapping = aes(x = age, y = hours_per_week),
       data = db.adult) + 
  geom_line(mapping = aes(color = income), 
            stat = 'summary', 
            fun = mean) +
  geom_smooth(mapping = aes(color = income), method = 'gam', formula = y ~ s(x, bs = "cs")) +
  scale_x_continuous(breaks = seq(10, 100, 5)) +
  labs(x = "Age", 
       y = "Mean Hours per Week") +
  ggtitle("Mean Hours per Week vs. Age")
```

### Created variable _hours_w_

```{r, echo=F, out.width="92%"}
db.adult <- within(db.adult, hours_w <- factor(hours_w, levels = 
                                                   names(sort(table(hours_w), 
                                                         decreasing = TRUE))))

ggplot(db.adult, 
       aes(x = hours_w, fill = hours_w)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = 0.3) +
  labs(x = "Hours per week", 
       y = "",
       fill = "Hours per week") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Bar Plot of Hours per Week") +  
  scale_y_continuous(labels = percent)
```

The percentage differences in hours per week between people in the two income categories are almost insignificant. The only exception is for the group between 45 and 60 hours a week, where 33.2% of people who earn more than 50K are situated compared to only 14.6% for the other income group.

```{r, echo=F, out.width="80%" }
lg_hpw <- lapply(levels(db.adult$income), function(v){
    
    df <- subset(db.adult, db.adult$income == v)  
    
    df <- within(df, hours_w <- factor(hours_w, 
                                       levels = names(sort(table(hours_w), 
                                                           decreasing = TRUE))))
  
    ggplot(data = df, 
         aes(x = hours_w, 
             fill = hours_w)) + 
      geom_bar(aes(y = (..count..)/sum(..count..))) +
      geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                    y = (..count..)/sum(..count..) ), 
                stat = "count",
                vjust = -.1,
                size = 3) +
      labs(x = "Hours per week", 
           y = "",
           fill = "Hours per week") +
      theme(legend.position = 'none',
            axis.text.x = element_text(angle = 45, hjust = 1)) +
      ggtitle(paste("Income", v, sep="")) + 
      scale_y_continuous(labels = percent) })


grid.arrange(grobs = lg_hpw, ncol = 2)
```

### Created variable _native_region_

Most of the people that participated in the survey originate from America.Because the data is so limited for the other regions, conclusions made from this analysis can only be applied to America.

```{r, echo=F, out.width="80%"}
db.adult$native_region <- factor(db.adult$native_region, 
                                 levels = 
                                     names(sort(table(db.adult$native_region),                                                 decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = native_region, fill = native_region)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1) +
  labs(x = "Region", 
       y = "",
       fill = "Regions") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +  
  scale_y_continuous(labels = percent)
```

### workclass 

It is important to consider employment type compared to income. Without-pay will be removed from the dataset as it seems to be an outlier that will skew the results. 

```{r, echo=F, out.width="85%"}
db.adult$workclass <- factor(db.adult$workclass, 
                             levels = 
                                     names(sort(table(db.adult$workclass),                                                    decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = workclass, fill = workclass)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1,
            size = 3.5) +
  labs(x = "Employment type", 
       y = "",
       fill = "Employment type") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +   
  scale_y_continuous(labels = percent)
```

```{r, echo=F, results='hide'}
modified.work <- levels(db.adult$workclass)
modified.work <- modified.work[!is.element(modified.work, 
                                           c(" Without-pay"))]

modified.work
```

```{r, echo=F, out.width="85%", results='hide'}
lg.workclass.mod <- lapply(modified.work, function(v){
  
  ggplot(data = subset(db.adult, db.adult$workclass == v), 
         aes(x = subset(db.adult, db.adult$workclass == v)$income, 
             fill = subset(db.adult, db.adult$workclass == v)$income)) +
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
              stat = "count",
              vjust = c(2, 1.5)) +
    labs(x = "Income", 
         y = "",
         fill = "Income") +
    ggtitle(v) +  
    theme(legend.position = 'none',
          plot.title = element_text(size = 11, face = "bold")) +
    scale_y_continuous(labels = percent) })


grid.arrange(grobs = lg.workclass.mod[1:3], ncol = 2)
```

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lg.workclass.mod[4:6], ncol = 2)
```

The percentage of people earning more than 50K a year is biggest for the _Self employed incorporated category_. The next category in the list for the highest percentage of people earning more than 50K is the _Federal government_. Except those first 2 categories, there aren't large differences in the distribution of the 2 income groups.  

### education

Since there are no people with Preschool level of education that earn more than 50K, this category will be removed.

```{r, echo=F, out.width="75%"}
db.adult$education <- factor(db.adult$education, 
                                 levels = 
                                     names(sort(table(db.adult$education),                                                    decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = education, fill = education)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1,
            size = 3.5) +
  labs(x = "Education", 
       y = "",
       fill = "Education") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = percent)
```
```{r, echo=F, results='hide'}
nrow(subset(db.adult, db.adult$education == " Preschool" &
                      db.adult$income == " >50K" ))

modified.edu <- levels(db.adult$education)

modified.edu <- modified.edu[!is.element(modified.edu, " Preschool")]
```
```{r, echo=F, out.width="85%"}
lg.mod.edu <- lapply(modified.edu, function(v){
  
  ggplot(data = subset(db.adult, db.adult$education == v), 
         aes(x = subset(db.adult, db.adult$education == v)$income, 
             fill = subset(db.adult, db.adult$education == v)$income)) +
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                  y = (..count..)/sum(..count..) ), 
             stat = "count",
             vjust =  c(2, 0.5),
             size = 3) +
    labs(x = "Income", 
         y = "",
         fill = "Income") +
    ggtitle(v) +  
    theme(legend.position = 'none',
          plot.title = element_text(size = 11, face = "bold")) +    
    scale_y_continuous(labels = percent) })

```

The categories spanning from 1st grade to 12th grade have a very limited percentage of people with income greater than 50K a year. For high school and college the percentages are also relatively small.The biggest percentage of people with an income over 50K belongs to the category " Prof-school" with 75%, followed by "Masters" with 56% and finally " Bachelors" with 42%. As of now, the data indicates the most important predictor of income category is the education level. 

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lg.mod.edu[1:4], ncol = 2) 
```

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lg.mod.edu[5:8], ncol = 2) 
```

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lg.mod.edu[9:12], ncol = 2) 
```

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lg.mod.edu[13:15], ncol = 2) 
```

### marital_status

```{r, echo=F, out.width="85%"}
db.adult$marital_status <- factor(db.adult$marital_status, 
                                 levels = 
                                     names(sort(table(db.adult$marital_status),                                               decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = marital_status, fill = marital_status)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1,
            size = 3.5) +
  labs(x = "Marital Status", 
       y = "",
       fill = "Marital Status") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = percent)
```

```{r, echo=F, out.width="85%"}
lp_marital <- lapply(levels(db.adult$marital_status), function(v){

  ggplot(data = subset(db.adult, db.adult$marital_status == v),
         aes(x = subset(db.adult, db.adult$marital_status == v)$income,
             fill = subset(db.adult, db.adult$marital_status == v)$income)) +   
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                  y = (..count..)/sum(..count..) ),
              stat = "count",
              vjust = c(2, -0.1)) +
    labs(x = "Income",
         y = "",
         fill = "Income") +
    ggtitle(v) +
    theme(legend.position = 'none',
          plot.title = element_text(size = 11, face = "bold")) +
    scale_y_continuous(labels = percent) })


grid.arrange(grobs = lp_marital[1:3], ncol = 2)
```

```{r, echo=F, out.width="85%"}
grid.arrange(grobs = lp_marital[4:7], ncol = 2)
```

The biggest percentage of people with income higher than 50K belong to the categories _" Married-AF-spouse"_ and _"Married-civ-spouse"_. Married people seem to earn more, but it's not possible to draw conclusion from this data alone. When taking into consideration the _age_ variable, then it might be possible to explain the differences by pointing out that older people earn more and are more likely to be married than younger people. 

### occupation

When it comes to occupation, the data seems to be diversified enough to be considered a random sample. 

```{r}
summary(db.adult$occupation)
```

```{r, echo=F, out.width="85%"}
db.adult$occupation <- factor(db.adult$occupation, 
                                 levels = 
                                     names(sort(table(db.adult$occupation),                                                   decreasing = TRUE)))

ggplot(db.adult,
       aes(x = occupation, fill = occupation)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ),
            stat = "count",
            vjust = -.1,
            size = 3.5) +
  labs(x = "Occupation",
       y = "Percentage",
       fill = "Occupation") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = percent)
```

### relationship

The relationship variable is closely related to _marital status_ and supports the previous data. 

```{r, echo=F, out.width="85%"}
db.adult$relationship <- factor(db.adult$relationship, 
                                 levels = 
                                     names(sort(table(db.adult$relationship),                                                 decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = relationship, fill = relationship)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1) +
  labs(x = "Relationship", 
       y = "",
       fill = "Relationship") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +  
  scale_y_continuous(labels = percent)
```

```{r, echo=F, out.width="85%"}
ggplot(db.adult, 
       aes(x = marital_status, fill = marital_status)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1,
            size = 3.5) +
  labs(x = "Marital Status", 
       y = "",
       fill = "Marital Status") +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = percent)
```

```{r, echo=F, out.width="85%"}
ggplot(db.adult, aes(x=relationship, fill=income)) +
  geom_bar(position=position_dodge()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Income", 
       y = "Number of people",
       fill = "Income") +
  ggtitle("Income grouped by relationship") +   
  scale_y_continuous(breaks = seq(0,7000,500))
```

### race

Most participants to the survey are white people, and because of this limitation it is not possible to extrapolate conclusions to the larger population.

```{r, echo=F, out.width="85%"}
db.adult$race <- factor(db.adult$race, 
                                 levels = 
                                     names(sort(table(db.adult$race),                                                         decreasing = TRUE)))

ggplot(db.adult, 
       aes(x = race, fill = race)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = c(-0.2, -0.2, -0.2, -0.2, 3)) +
  labs(x = "Race", 
       y = "",
       fill = "Race") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  
  scale_y_continuous(labels = percent)
```

```{r, echo=F, out.width="85%"}
lg.race <- lapply(levels(db.adult$race), function(v){
  
  ggplot(data = subset(db.adult, db.adult$race == v), 
         aes(x = subset(db.adult, db.adult$race == v)$income, 
             fill = subset(db.adult, db.adult$race == v)$income)) + 
    geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                  y = (..count..)/sum(..count..) ), 
              stat = "count",
              vjust = c(2, -0.1)) +
    labs(x = "Income", 
         y = "",
         fill = "Income") +
    ggtitle(paste(v)) +  
    theme(legend.position = 'none',
          plot.title = element_text(size = 11, face = "bold")) +     
    scale_y_continuous(labels = percent) })


grid.arrange(grobs = lg.race, ncol = 3)
```

### The variable _sex_

Taking into consideration the _race_ variable it is possible to conclude that most survey respondents are white males.  
There is a change the dataset might be biased. 

```{r}
summary(db.adult$sex)
```

```{r, echo=F, out.width="85%"}
ggplot(db.adult, 
       aes(x = sex, fill = sex)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -.1) +
  labs(x = "Gender", 
       y = "Percentage",
       fill = "Gender") +
  scale_y_continuous(labels = percent)
```

```{r, echo=F, out.width="85%"}
gender.income <- lapply(levels(db.adult$sex), function(v){
  
ggplot(data = subset(db.adult, sex == v), 
         aes(x = subset(db.adult, sex == v)$income, 
             fill = subset(db.adult, sex == v)$income))+
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                y = (..count..)/sum(..count..) ), 
            stat = "count",
            vjust = -0.1,
            size = 3) +
  labs(x = "Income", 
       y = "",
       fill = "Income") +
  ggtitle(paste(v)) +  
  theme(legend.position = 'none',
        plot.title = element_text(size = 11, face = "bold"),
        axis.text.x = element_text(hjust = 1)) +     
  scale_y_continuous(labels = percent) })

grid.arrange(grobs = gender.income, ncol = 2)
```

## Tests for independence of variables

Pearson’s Chi Square Test of Independence will be used to test the independence of the categorical variables two by two.  
The following null hypothesis will be tested:  
H1: The two categorical variables are independent in the considered population against the alternative hypothesis    
H2: The two categorical variables are dependent (related) in the considered population.  

### variables _sex_ and _income_

The p-value is less than 0.05 which means the null hypothesis that the two categorical variables are independent is rejected.

```{r, echo=F, results='hide'}
CrossTable(db.adult$sex, db.adult$income, 
           prop.chisq = TRUE,
           chisq = TRUE)
```
```{r}
chisq.test(db.adult$sex, db.adult$income)
```
### variables _race_ and _income_

The null hypothesis is rejected at the 0.05 significance level, the p-values are less than 0.05. This indicates there is a strong correlation between "race" and "income".

```{r}
chisq.test(db.adult$race, db.adult$income)
```
```{r, echo=F, results='hide'}
CrossTable(db.adult$race, db.adult$income, 
           prop.chisq = TRUE,
           chisq = TRUE)
```
### variables _workclass_ and _income_

A warning message is displayed, most likely because there are cells with expected cell counts less than 5.  
The results are to be interpreted with caution or neglected.

```{r}
chisq.test(table(db.adult$workclass, db.adult$income)) 
```
```{r, echo=F, results='hide'}
chisq.test(table(db.adult$workclass, db.adult$income))$expected
```





